#!/usr/bin/python3

import argparse
import re
import os
import shutil
import tools.scripts.extract_compiler_cmd
from typing import Sequence
from pathlib import Path

COMPILE_COMMAND_LINE = 'xtensa-esp32-elf-gcc -std=gnu99 -Og -ggdb -Wno-frame-address -ffunction-sections -fdata-sections -fstrict-volatile-bitfields -mlongcalls -nostdlib -Wall -Werror=all -Wno-error=unused-function -Wno-error=unused-but-set-variable -Wno-error=unused-variable -Wno-error=deprecated-declarations -Wextra -Wno-unused-parameter -Wno-sign-compare -Wno-old-style-declaration -DESP_SUPPLICANT -DIEEE8021X_EAPOL -DEAP_PEER_METHOD -DEAP_TLS -DEAP_TTLS -DEAP_PEAP -DEAP_MSCHAPv2 -DUSE_WPA2_TASK -DCONFIG_WPS2 -DCONFIG_WPS_PIN -DUSE_WPS_TASK -DESPRESSIF_USE -DESP32_WORKAROUND -DCONFIG_ECC -D__ets__ -Wno-strict-aliasing -DESP_PLATFORM -D IDF_VER=\"v4.0-dirty\" -MMD -MP   -D_GNU_SOURCE -DGCC_NOT_5_2_0=1 -DMBEDTLS_CONFIG_FILE=' "mbedtls/esp_config.hh" ' -DHAVE_CONFIG_H -DUNITY_INCLUDE_CONFIG_H -I /home/dummy1/projects/esp-idf/components/wpa_supplicant/src -I /home/dummy1/projects/esp-idf/components/wpa_supplicant/include -I /home/dummy1/projects/esp-idf/components/wpa_supplicant/port/include -I /home/dummy1/projects/esp-idf/components/wpa_supplicant/include/esp_supplicant -I /home/dummy1/projects/esp-idf/components/app_trace/include -I /home/dummy1/projects/esp-idf/components/app_update/include -I /home/dummy1/projects/esp-idf/components/asio/asio/asio/include -I /home/dummy1/projects/esp-idf/components/asio/port/include -I /home/dummy1/projects/esp-idf/components/bootloader_support/include -I /home/dummy1/projects/esp-idf/components/bt/include -I /home/dummy1/projects/esp-idf/components/coap/port/include -I /home/dummy1/projects/esp-idf/components/coap/port/include/coap -I /home/dummy1/projects/esp-idf/components/coap/libcoap/include -I /home/dummy1/projects/esp-idf/components/coap/libcoap/include/coap2 -I /home/dummy1/projects/esp-idf/components/console -I /home/dummy1/projects/esp-idf/components/driver/include -I /home/dummy1/projects/esp-idf/components/efuse/esp32/include -I /home/dummy1/projects/esp-idf/components/efuse/include -I /home/dummy1/projects/esp-idf/components/esp-tls -I /home/dummy1/projects/esp-idf/components/esp-tls/private_include -I /home/dummy1/projects/esp-idf/components/esp32/include -I /home/dummy1/projects/esp-idf/components/esp_adc_cal/include -I /home/dummy1/projects/esp-idf/components/esp_common/include -I /home/dummy1/projects/esp-idf/components/esp_eth/include -I /home/dummy1/projects/esp-idf/components/esp_event/include -I /home/dummy1/projects/esp-idf/components/esp_gdbstub/include -I /home/dummy1/projects/esp-idf/components/esp_http_client/include -I /home/dummy1/projects/esp-idf/components/esp_http_server/include -I /home/dummy1/projects/esp-idf/components/esp_https_ota/include -I /home/dummy1/projects/esp-idf/components/esp_local_ctrl/include -I /home/dummy1/projects/esp-idf/components/esp_ringbuf/include -I /home/dummy1/projects/esp-idf/components/esp_rom/include -I /home/dummy1/projects/esp-idf/components/esp_websocket_client/include -I /home/dummy1/projects/esp-idf/components/esp_wifi/include -I /home/dummy1/projects/esp-idf/components/esp_wifi/esp32/include -I /home/dummy1/projects/esp-idf/components/espcoredump/include -I /home/dummy1/projects/esp-idf/components/expat/expat/expat/lib -I /home/dummy1/projects/esp-idf/components/expat/port/include -I /home/dummy1/projects/esp-idf/components/fatfs/diskio -I /home/dummy1/projects/esp-idf/components/fatfs/vfs -I /home/dummy1/projects/esp-idf/components/fatfs/src -I /home/dummy1/projects/esp-idf/components/freemodbus/common/include -I /home/dummy1/projects/esp-idf/components/freertos/include -I /home/dummy1/projects/esp-idf/components/heap/include -I /home/dummy1/projects/esp-idf/components/idf_test/include -I /home/dummy1/projects/esp-idf/components/jsmn/include -I /home/dummy1/projects/esp-idf/components/json/cJSON -I /home/dummy1/projects/esp-idf/components/libsodium/libsodium/src/libsodium/include -I /home/dummy1/projects/esp-idf/components/libsodium/port_include -I /home/dummy1/projects/esp-idf/components/log/include -I /home/dummy1/projects/esp-idf/components/lwip/include/apps -I /home/dummy1/projects/esp-idf/components/lwip/include/apps/sntp -I /home/dummy1/projects/esp-idf/components/lwip/lwip/src/include -I /home/dummy1/projects/esp-idf/components/lwip/port/esp32/include -I /home/dummy1/projects/esp-idf/components/lwip/port/esp32/include/arch -I /home/dummy1/projects/esp-idf/examples/get-started/hello_world/main/include -I /home/dummy1/projects/esp-idf/components/mbedtls/port/include -I /home/dummy1/projects/esp-idf/components/mbedtls/mbedtls/include -I /home/dummy1/projects/esp-idf/components/mdns/include -I /home/dummy1/projects/esp-idf/components/mqtt/esp-mqtt/include -I /home/dummy1/projects/esp-idf/components/newlib/platform_include -I /home/dummy1/projects/esp-idf/components/nghttp/port/include -I /home/dummy1/projects/esp-idf/components/nghttp/nghttp2/lib/includes -I /home/dummy1/projects/esp-idf/components/nvs_flash/include -I /home/dummy1/projects/esp-idf/components/openssl/include -I /home/dummy1/projects/esp-idf/components/protobuf-c/protobuf-c -I /home/dummy1/projects/esp-idf/components/protocomm/include/common -I /home/dummy1/projects/esp-idf/components/protocomm/include/security -I /home/dummy1/projects/esp-idf/components/protocomm/include/transports -I /home/dummy1/projects/esp-idf/components/pthread/include -I /home/dummy1/projects/esp-idf/components/sdmmc/include -I /home/dummy1/projects/esp-idf/components/soc/esp32/include -I /home/dummy1/projects/esp-idf/components/soc/include -I /home/dummy1/projects/esp-idf/components/spi_flash/include -I /home/dummy1/projects/esp-idf/components/spiffs/include -I /home/dummy1/projects/esp-idf/components/tcp_transport/include -I /home/dummy1/projects/esp-idf/components/tcpip_adapter/include -I /home/dummy1/projects/esp-idf/components/ulp/include -I /home/dummy1/projects/esp-idf/components/unity/include -I /home/dummy1/projects/esp-idf/components/unity/unity/src -I /home/dummy1/projects/esp-idf/components/vfs/include -I /home/dummy1/projects/esp-idf/components/wear_levelling/include -I /home/dummy1/projects/esp-idf/components/wifi_provisioning/include -I /home/dummy1/projects/esp-idf/components/xtensa/include -I /home/dummy1/projects/esp-idf/components/xtensa/esp32/include -I /home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/include  -I src/wps -c /home/dummy1/projects/esp-idf/components/wpa_supplicant/src/wps/wps_attr_build.c -o src/wps/wps_attr_build.o'
LINKER_COMMAND_LINE = 'xtensa-esp32-elf-gcc -nostdlib -u call_user_start_cpu0  -Wl,--gc-sections -Wl,-static -Wl,--start-group  -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/app_trace -lapp_trace -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/app_update -lapp_update -u esp_app_desc -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/asio -lasio -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/bootloader_support -lbootloader_support -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/bt -lbt -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/coap -lcoap -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/console -lconsole -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/cxx -lcxx -u __cxa_guard_dummy -u __cxx_fatal_exception -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/driver -ldriver -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/efuse -lefuse -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp-tls -lesp-tls -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp32 -lesp32 -L /home/dummy1/projects/esp-idf/components/esp32/ld -T esp32_out.ld -u ld_include_panic_highint_hdl -T /home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp32/esp32.project.ld -T esp32.peripherals.ld  -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_adc_cal -lesp_adc_cal -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_common -lesp_common -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_eth -lesp_eth -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_event -lesp_event -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_gdbstub -lesp_gdbstub -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_http_client -lesp_http_client -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_http_server -lesp_http_server -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_https_ota -lesp_https_ota -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_local_ctrl -lesp_local_ctrl -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_ringbuf -lesp_ringbuf -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_rom -lesp_rom -L /home/dummy1/projects/esp-idf/components/esp_rom/esp32/ld -T esp32.rom.ld -T esp32.rom.libgcc.ld -T esp32.rom.syscalls.ld -T esp32.rom.newlib-data.ld -T esp32.rom.newlib-funcs.ld  -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_websocket_client -lesp_websocket_client -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/esp_wifi -lesp_wifi -L/home/dummy1/projects/esp-idf/components/esp_wifi/lib_esp32 -lcore -lrtc -lnet80211 -lpp -lsmartconfig -lcoexist -lespnow -lphy -lmesh -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/espcoredump -lespcoredump -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/expat -lexpat -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/fatfs -lfatfs -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/freemodbus -lfreemodbus -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/freertos -lfreertos -Wl,--undefined=uxTopUsedPriority -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/heap -lheap -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/idf_test -lidf_test -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/jsmn -ljsmn -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/json -ljson -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/libsodium -llibsodium -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/log -llog -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/lwip -llwip -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/main -lmain -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/mbedtls -lmbedtls -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/mdns -lmdns -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/mqtt -lmqtt -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/newlib -lnewlib -lc -lm -u newlib_include_locks_impl -u newlib_include_heap_impl -u newlib_include_syscalls_impl -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/nghttp -lnghttp -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/nvs_flash -lnvs_flash -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/openssl -lopenssl -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/protobuf-c -lprotobuf-c -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/protocomm -lprotocomm -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/pthread -lpthread -u pthread_include_pthread_impl -u pthread_include_pthread_cond_impl -u pthread_include_pthread_local_storage_impl -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/sdmmc -lsdmmc -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/soc -lsoc -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/spi_flash -lspi_flash -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/spiffs -lspiffs -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/tcp_transport -ltcp_transport -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/tcpip_adapter -ltcpip_adapter -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/ulp -lulp -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/unity -lunity -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/vfs -lvfs -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/wear_levelling -lwear_levelling -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/wifi_provisioning -lwifi_provisioning -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/wpa_supplicant -lwpa_supplicant -L/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/xtensa -lxtensa /home/dummy1/projects/esp-idf/components/xtensa/esp32/libhal.a -lgcc -lstdc++ -lgcov -Wl,--end-group -Wl,-EL -fno-rtti -o /home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/hello-world.elf -Wl,-Map=/home/dummy1/projects/esp-idf/examples/get-started/hello_world/build/hello-world.map'


def copyFiles(output: Path, fileList: Sequence[Path]) -> None:
	if not output.is_dir():
		os.makedirs(output)
	for f in fileList:
		shutil.copyfile(f, output.joinpath(f.name))


def copyFileTree(output: Path, fileList: Sequence[Path], pattern: str) -> None:
	regexpr = re.compile(pattern)
	if not output.is_dir():
		os.makedirs(output)
	for f in fileList:
		for root, dirs, files in os.walk(f.as_posix()):
			for name in files:
				path = Path(root).joinpath(name)
				if re.match(regexpr, path.as_posix()):
					relPath = path.relative_to(f)
					dst = output.joinpath(relPath)
					if not dst.parent.is_dir():
						os.makedirs(dst.parent)
					shutil.copyfile(path.as_posix(), dst.as_posix())


if __name__ == "__main__":
	parser = argparse.ArgumentParser(description="Generate the content of the esp32 SDK from esp-idf.")
	parser.add_argument("output", type=Path, help="Output directory where to store the results.")

	args = parser.parse_args()

	# Create the output directory
	outputResolved = args.output.expanduser().resolve()
	if input("Do you want to create and clean '{}'? ".format(outputResolved.as_posix())).lower().strip() == "y":
		if outputResolved.is_dir():
			shutil.rmtree(outputResolved)
		os.makedirs(outputResolved)

	for cmdStr in [COMPILE_COMMAND_LINE, LINKER_COMMAND_LINE]:
		result = tools.scripts.extract_compiler_cmd.parse(cmdStr)

		copyFiles(outputResolved.joinpath("ld"), [Path(f) for f in result["files"]["lds"]])
		copyFiles(outputResolved.joinpath("lib"), [Path(f) for f in result["files"]["libs"]])
		copyFileTree(outputResolved.joinpath("include"),
			[Path(f) for f in filter(lambda x: x not in ["."], result["files"]["includes"])], r'.*\.h')

		print("Linker commands (lds): {}".format(" ".join(["-T{}".format(p) for p in result["linker"]["lds"]])))
		print("Linker commands (libs): {}".format(" ".join(["-l{}".format(p) for p in result["linker"]["libs"]])))
