#!/usr/bin/env groovy
/**
 * It requires the following Jenkins plugins to work:
 * - Warnings Next Generation
 * - JUnit Plugin
 * - valgrind
 */
pipeline {
	agent none
	stages
	{
		/**
		 * This step is to ensure that the dockerfile is generated by only 1 worker to avoid
		 * multiple jobs to do the same operation.
		 */
		stage("Setup docker image")
		{
			agent
			{
				dockerfile
				{
					filename "tools/jenkins/debian.dockerfile"
				}
			}
			stages
			{
				stage("Setup docker image completed")
				{
					steps
					{
						echo "Setup docker image completed"
					}
				}
			}
		}

		/**
		 * The actual tests are done here
		 */
		stage("Tests")
		{
			parallel
			{
				stage("bazel test ...")
				{
					agent
					{
						dockerfile
						{
							filename "tools/jenkins/debian.dockerfile"
						}
					}
					stages
					{
						stage("Test")
						{
							steps
							{
								sh "bazel test ..." 
							}
						}
					}
					/*post
					{
						always
						{
							// This is needed to avoid an error if there are no steps in this block
							echo "Post bazel test ..."
							recordIssues enabledForFailure: true, aggregatingResults: true, id: "debian.cmake.clang-debug", tools: [clang()]
							junit '*_junit.report'
						}
					}*/
				}
			}
		}
	}
}
